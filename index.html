<html>
  <head>
    <title>ink.gen</title>
    <meta charset="UTF-8">
    <style>
      body {
        background: linear-gradient(to top, #ffe8ec 60%, #fff5f5);
        font-family: sans-serif, bold;
        font-size: small;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }

      .canvas-container {
        max-height: 90vh;
      }

      canvas {
        margin-left: auto;
        margin-right: auto;
        display: block;
        font-family: 'Roboto Condensed', sans-serif, bold;
      }

      .button-container {
        display: flex;
        justify-content: center;
      }

      .mandala-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow-y: auto;
        overflow-x: hidden;
        height: 800px;
        width: 240px;
        position: absolute;
        left: -260;
        border-top: 2px solid #a2737b;
        border-bottom: 2px solid #a2737b;
        padding-top: 12px;
        padding-bottom: 12px;
        box-sizing: border-box;
        align-items: center;

        visibility: hidden;
      }

      .mandala-list::-webkit-scrollbar {
        background: none;
        border-style: none;
        width: 0.4vw;
        min-width: 6px;
      }

      .mandala-list::-webkit-scrollbar-thumb {
        border-radius: 16px;
        background: #fc68ad3a;
        border: 1px solid #a2737b;
      }

      .mandala-thumbnail {
        max-width: 200px;
        object-fit: cover;
        cursor: pointer;
        border-radius: 100%;
        border: 2px solid #a2737b;
        box-shadow: 0 4px #8d3d633a;
      }

      .mandala-preview {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      #mainImage {
        width: 800px;
        height: 800px;
        background-color: #ffffff70;
        border-radius: 100%;
        border: 2px solid #a2737b;
        box-shadow: 0 0 40px 20px #ffffff30;
      }

      h2 {
        margin: 0;
        margin-right: 20px;
      }

      .nav {
        display: flex;
        flex: auto;
        align-items: baseline;
      }

      input, button {
        border-radius: 8px;
        border: 1px solid #a2737b;
        background: #fc68ad24;
        margin-right: 4px;
        height: 24px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="nav">
        <h2>ink.gen</h2>
        <div>
          <button id="uploadButton">Upload Image</button>
          <input type="file" id="imageInput" style="display: none;">
          Points:
          <input type="number" id="numPointsInput" min="3" max="360" value="5">
          <button onclick="updatePoints()">Update</button>
          <button onclick="generateMandala()">Generate Mandala</button>
          <button onclick="downloadImage()">Download</button>
        </div>
      </div>
      <div style="position: relative">
        <div class="mandala-list" id="mandalaList"></div>
        <img id="mainImage" src="https://i.imgur.com/ArMb4g8.png"/>
      </div>
    </div>
    <canvas id="buffer" width="3300px" height="3300px" style="display: none;"></canvas>

    <script>
      var bufferElement = document.getElementById("buffer");
      var buffer        = bufferElement.getContext("2d");
      var bufferWidth   = bufferElement.width;
      var bufferHeight  = bufferElement.height;


      var mainImage     = document.getElementById('mainImage');
      var currentImage  = null;

      var numPointsInput = document.getElementById('numPointsInput');
      var uploadButton   = document.getElementById('uploadButton');
      var imageInput     = document.getElementById('imageInput');

      var mandalaList    = document.getElementById("mandalaList");
      var mandalaImages  = [];

      var numPoints      = parseInt(numPointsInput.value);
      var angleIncrement = (360 / numPoints) / 2;

      uploadButton.addEventListener('click', function() {
        imageInput.click();
      });

      imageInput.addEventListener('change', function(event) {
        loadImage(event);
      });

      var loadImage = function(event) {
        var input = event.target;

        if (input.files && input.files[0]) {
          var reader = new FileReader();

          reader.onload = function(e) {
            var img = new Image();

            img.src = e.target.result;

            img.onload = function() {
              image = imageHandle.scaleAndCropImage(img, bufferElement.width, bufferElement.height);
              image.onload = function() {
                saveMandala(image);
                mandalaList.style = "visibility: visible";

                generateMandala();
              };
            };
          };

          reader.readAsDataURL(input.files[0]);
        }
      };

      var imageHandle = {
        rotate: function(d, a, t) {
          buffer.clearRect(0, 0, bufferWidth, bufferHeight);
          buffer.save();
          buffer.translate(bufferWidth / 2 + t, bufferHeight / 2);
          buffer.rotate((a + d) * Math.PI / 180);
          buffer.drawImage(currentImage, -currentImage.width / 2, -currentImage.height / 2);
          buffer.restore();

          buffer.clearRect(0, 0, bufferWidth / 2, bufferHeight);
        },
        halfSlice: function(img, d) {
          buffer.clearRect(0, 0, bufferWidth, bufferHeight);
          buffer.save();
          buffer.translate(img.width / 2, img.height / 2);
          buffer.rotate(-d * Math.PI / 180);
          buffer.drawImage(img, -img.width / 2, -img.height / 2);
          buffer.restore();
          buffer.clearRect(bufferWidth / 2, 0, bufferWidth / 2, bufferHeight);
        },
        fullSlice: function(img) {
          buffer.clearRect(0, 0, bufferWidth, bufferHeight);
          buffer.drawImage(img, 0, 0);
          buffer.save();
          buffer.translate(bufferWidth, 0);
          buffer.scale(-1, 1);
          buffer.drawImage(img, 0, 0, bufferWidth / 2, bufferHeight, 0, 0, bufferWidth / 2, bufferHeight);
          buffer.restore();
        },

        scaleAndCropImage: function(img, width, height) {
          var aspectRatio = img.width / img.height;
          var scaledWidth, scaledHeight, dx, dy;

          if (img.width > img.height) {
            scaledWidth = height * (img.width / img.height);
            scaledHeight = height;
            dx = (width - scaledWidth) / 2;
            dy = 0;
          } else {
            scaledWidth  = width;
            scaledHeight = width * (img.height / img.width);
            dx = 0;
            dy = (height - scaledHeight) / 2;
          }

          buffer.clearRect(0, 0, width, height);
          buffer.drawImage(img, dx, dy, scaledWidth, scaledHeight);

          var scaledImage = new Image();
          scaledImage.src = bufferElement.toDataURL('image/png', 1);

          return scaledImage;
        },
        cropToCircle: function(image) {
          var size = image.width + 10;
          bufferElement.width = size;
          bufferElement.height = size;

          buffer.beginPath();
          buffer.arc(size / 2, size / 2, size / 2, 0, 2 * Math.PI);
          buffer.closePath();
          buffer.clip();

          buffer.clearRect(0, 0, bufferWidth, bufferHeight);
          buffer.drawImage(image, 0, 0, size, size);

          var croppedImage = new Image();
          croppedImage.src = bufferElement.toDataURL('image/png', 1);

          return croppedImage;
        }
      };

      var generateMandala = function() {
        var sliceImage = new Image();
        var flippedImage = new Image();
        var repetitionImage = null;
        currentImage = image;

        bufferElement.width = 3300;
        bufferElement.height = 3300;

        var drawSlice = function(degrees) {
          var angleOffset = Math.floor(Math.random() * 360) + 1;
          var translationOffset = Math.floor(Math.random() * (currentImage.width * 0.1));

          imageHandle.rotate(degrees, angleOffset, translationOffset);

          sliceImage.src = bufferElement.toDataURL('image/png', 1);
          sliceImage.onload = function() {
            imageHandle.halfSlice(sliceImage, degrees);

            flippedImage.src = bufferElement.toDataURL('image/png', 1);
            flippedImage.onload = processFlippedImage;
          };
        };

        var processFlippedImage = function() {
          imageHandle.fullSlice(flippedImage);

          var fullSlice = new Image();
          fullSlice.src = bufferElement.toDataURL('image/png', 1);
          fullSlice.onload = processFullSlice.bind(null, fullSlice);
        };

        var processFullSlice = function(fullSlice) {
          buffer.clearRect(0, 0, bufferWidth, bufferHeight);
          buffer.drawImage(fullSlice, 0, 0, bufferWidth, bufferHeight);

          if (!repetitionImage) {
            repetitionImage = new Image();
            repetitionImage.src = bufferElement.toDataURL('image/png', 1);
          }

          buffer.clearRect(0, 0, bufferWidth, bufferHeight);
          buffer.fillStyle = 'white';
          buffer.fillRect(0, 0, bufferWidth, bufferHeight);

          buffer.save();
          buffer.translate(bufferWidth / 2, bufferHeight / 2);

          for (var i = 0; i < (360 / angleIncrement); i++) {
            buffer.rotate((angleIncrement * 2) * Math.PI / 180);
            buffer.drawImage(repetitionImage, -fullSlice.width / 2, -fullSlice.height / 2);
          }

          buffer.restore();

          var finalImage = new Image();
          finalImage.src = bufferElement.toDataURL('image/png', 1);
          finalImage.onload = processFinalImage.bind(null, finalImage);
        };

        var processFinalImage = function(finalImage) {
          var croppedImage = imageHandle.cropToCircle(finalImage);
          mainImage.src = croppedImage.src;
          saveMandala(croppedImage);
        };

        drawSlice(angleIncrement);
      };

      var saveMandala = function(image) {
        var thumbnailImage = document.createElement('img');

        thumbnailImage.src = image.src;
        thumbnailImage.classList.add('mandala-thumbnail');

        thumbnailImage.onclick = function() {
          loadMandala(image);
        };

        mandalaImages.push(thumbnailImage);
        mandalaList.insertBefore(thumbnailImage, mandalaList.firstChild);
      };

      var loadMandala = function(image) {
        mainImage.src = image.src;
      };

      var downloadImage = function() {
        var link = document.createElement('a');

        link.href = mainImage.src;
        link.download = 'mandala.png';

        link.click();
      };

      var updatePoints = function() {
        var pointsInput = document.getElementById('numPointsInput');
        var newNumPoints = parseInt(pointsInput.value);

        if (Number(newNumPoints) && newNumPoints >= 3) {
          numPoints = newNumPoints;
          angleIncrement = (360 / numPoints) / 2;

          generateMandala();
        } else {
          pointsInput.value = numPoints;

          alert('Please enter a valid number of points (minimum 3).');
        }
      };

    </script>

  </body>
</html>
